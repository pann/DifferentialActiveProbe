<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Differential Probe - Test Runner</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --accent: #0f3460;
            --highlight: #e94560;
            --text: #eaeaea;
            --text-muted: #a0a0a0;
            --pass: #2ecc71;
            --fail: #e74c3c;
            --pending: #f39c12;
            --input-bg: #0a0a15;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-color);
            color: var(--text);
            line-height: 1.6;
            padding: 1rem;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--accent);
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 {
            font-size: 1.5rem;
            color: var(--highlight);
        }

        .header-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .save-indicator {
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        .save-indicator.saved {
            color: var(--pass);
        }

        .save-indicator.unsaved {
            color: var(--fail);
            font-weight: bold;
        }

        .btn-primary {
            background: var(--pass) !important;
        }

        button {
            background: var(--accent);
            color: var(--text);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        button:hover {
            background: var(--highlight);
        }

        button.primary {
            background: var(--highlight);
        }

        .dut-info {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .dut-info label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .dut-info input {
            width: 100%;
            padding: 0.5rem;
            background: var(--input-bg);
            border: 1px solid var(--accent);
            border-radius: 4px;
            color: var(--text);
            font-size: 0.9rem;
        }

        .category {
            margin-bottom: 1.5rem;
        }

        .category-header {
            background: var(--accent);
            padding: 0.75rem 1rem;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .category-header h2 {
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .category-stats {
            display: flex;
            gap: 0.5rem;
            font-size: 0.8rem;
        }

        .stat-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-weight: 600;
        }

        .stat-pass { background: var(--pass); color: #000; }
        .stat-fail { background: var(--fail); color: #fff; }
        .stat-pending { background: var(--pending); color: #000; }

        .category-tests {
            background: var(--card-bg);
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }

        .test-item {
            border-bottom: 1px solid var(--accent);
        }

        .test-item:last-child {
            border-bottom: none;
        }

        .test-header {
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .test-header:hover {
            background: rgba(255,255,255,0.05);
        }

        .test-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .test-id {
            font-weight: 600;
            color: var(--highlight);
            min-width: 2.5rem;
        }

        .test-name {
            font-size: 0.9rem;
        }

        .test-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-indicator.pass { background: var(--pass); }
        .status-indicator.fail { background: var(--fail); }
        .status-indicator.pending { background: var(--pending); }

        .last-run {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .expand-icon {
            transition: transform 0.2s;
            color: var(--text-muted);
        }

        .test-item.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .test-content {
            display: none;
            padding: 1rem;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid var(--accent);
        }

        .test-item.expanded .test-content {
            display: block;
        }

        .test-section {
            margin-bottom: 1rem;
        }

        .test-section h4 {
            font-size: 0.85rem;
            color: var(--highlight);
            margin-bottom: 0.5rem;
        }

        .test-section p, .test-section ul, .test-section table {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .test-section ul {
            margin-left: 1.5rem;
        }

        .test-section table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
        }

        .test-section th, .test-section td {
            padding: 0.4rem 0.6rem;
            text-align: left;
            border: 1px solid var(--accent);
        }

        .test-section th {
            background: var(--accent);
            color: var(--text);
        }

        .run-test-form {
            background: var(--accent);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .run-test-form h4 {
            margin-bottom: 0.75rem;
            color: var(--text);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 0.5rem;
            background: var(--input-bg);
            border: 1px solid var(--bg-color);
            border-radius: 4px;
            color: var(--text);
            font-size: 0.85rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .history-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--accent);
        }

        .history-section h4 {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .history-list {
            display: none;
        }

        .history-list.visible {
            display: block;
        }

        .history-item {
            background: var(--bg-color);
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .history-item-date {
            color: var(--text-muted);
        }

        .history-item-status {
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .history-item-status.pass { background: var(--pass); color: #000; }
        .history-item-status.fail { background: var(--fail); color: #fff; }

        .history-item-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .delete-btn {
            background: transparent;
            color: var(--text-muted);
            border: none;
            padding: 0.1rem 0.4rem;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 3px;
            line-height: 1;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: var(--fail);
            color: #fff;
        }

        /* Test management buttons */
        .delete-test-btn {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--text-muted);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            border-radius: 3px;
            margin-left: 0.5rem;
            transition: all 0.2s;
        }

        .delete-test-btn:hover {
            background: var(--fail);
            border-color: var(--fail);
            color: #fff;
        }

        .add-test-btn {
            background: var(--accent);
            color: var(--text);
            border: 1px dashed var(--text-muted);
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 0.5rem;
            width: 100%;
            transition: all 0.2s;
        }

        .add-test-btn:hover {
            background: var(--highlight);
            border-color: var(--highlight);
        }

        .add-test-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1500;
            justify-content: center;
            align-items: flex-start;
            padding: 2rem;
            overflow-y: auto;
        }

        .add-test-modal.visible {
            display: flex;
        }

        .add-test-form {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            max-width: 700px;
            width: 100%;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
        }

        .add-test-form h3 {
            color: var(--highlight);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-test-form .form-section {
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--accent);
            border-radius: 4px;
        }

        .add-test-form .form-section h4 {
            color: var(--text);
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .add-test-form .form-group {
            margin-bottom: 0.75rem;
        }

        .add-test-form .form-group label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .add-test-form .form-group input,
        .add-test-form .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            background: var(--input-bg);
            border: 1px solid var(--bg-color);
            border-radius: 4px;
            color: var(--text);
            font-size: 0.85rem;
        }

        .add-test-form .form-group textarea {
            min-height: 80px;
            font-family: inherit;
        }

        .dynamic-list {
            margin-top: 0.5rem;
        }

        .dynamic-list-item {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .dynamic-list-item input {
            flex: 1;
        }

        .dynamic-list-item button {
            padding: 0.25rem 0.5rem;
            background: var(--fail);
            border: none;
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }

        .add-list-item-btn {
            background: var(--accent);
            color: var(--text);
            border: 1px dashed var(--text-muted);
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 3px;
            margin-top: 0.25rem;
        }

        .add-list-item-btn:hover {
            background: var(--highlight);
            border-color: var(--highlight);
        }

        .criteria-row {
            display: grid;
            grid-template-columns: 80px 1fr 60px 60px 60px auto;
            gap: 0.35rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .criteria-row input,
        .criteria-row select {
            padding: 0.3rem;
            background: var(--input-bg);
            border: 1px solid var(--bg-color);
            border-radius: 3px;
            color: var(--text);
            font-size: 0.75rem;
            min-width: 0;
        }

        .criteria-row .numeric-fields {
            display: contents;
        }

        .criteria-row .numeric-fields input {
            transition: opacity 0.2s;
        }

        .criteria-row.passfail-mode .numeric-fields input {
            opacity: 0.3;
            pointer-events: none;
        }

        .field-row {
            display: grid;
            grid-template-columns: 80px 1fr 70px 80px auto;
            gap: 0.35rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .field-row input,
        .field-row select {
            padding: 0.3rem;
            background: var(--input-bg);
            border: 1px solid var(--bg-color);
            border-radius: 3px;
            color: var(--text);
            font-size: 0.75rem;
            min-width: 0;
        }

        .add-test-form .form-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }

        #save-defs-btn.has-changes {
            background: var(--pending);
            color: #000;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .history-item-values {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
        }

        .history-value {
            display: flex;
            flex-direction: column;
        }

        .history-value-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .history-value-data {
            color: var(--text);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.visible {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            margin-bottom: 1rem;
            color: var(--highlight);
        }

        .modal-content textarea {
            width: 100%;
            height: 200px;
            padding: 0.5rem;
            background: var(--input-bg);
            border: 1px solid var(--accent);
            border-radius: 4px;
            color: var(--text);
            font-family: monospace;
            font-size: 0.8rem;
            margin-bottom: 1rem;
        }

        .modal-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* Image upload styles */
        .image-upload-group {
            margin-top: 0.75rem;
        }

        .image-upload-group label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            display: block;
        }

        .image-upload-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .image-upload-row input[type="file"] {
            flex: 1;
            padding: 0.4rem;
            background: var(--input-bg);
            border: 1px solid var(--bg-color);
            border-radius: 4px;
            color: var(--text);
            font-size: 0.8rem;
        }

        .image-preview {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            object-fit: cover;
            display: none;
            border: 1px solid var(--accent);
        }

        .image-preview.visible {
            display: block;
        }

        .clear-image-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            background: var(--fail);
            display: none;
        }

        .clear-image-btn.visible {
            display: inline-block;
        }

        /* History image thumbnail */
        .history-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            object-fit: cover;
            cursor: pointer;
            margin-top: 0.5rem;
            border: 2px solid var(--accent);
            transition: border-color 0.2s, transform 0.2s;
        }

        .history-thumbnail:hover {
            border-color: var(--highlight);
            transform: scale(1.05);
        }

        /* Lightbox modal */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .lightbox.visible {
            display: flex;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            z-index: 2001;
        }

        .lightbox-close:hover {
            color: var(--highlight);
        }

        .summary-bar {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .summary-stats {
            display: flex;
            gap: 1.5rem;
        }

        .summary-stat {
            text-align: center;
        }

        .summary-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .summary-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .summary-stat-value.pass { color: var(--pass); }
        .summary-stat-value.fail { color: var(--fail); }
        .summary-stat-value.pending { color: var(--pending); }

        .progress-bar {
            width: 200px;
            height: 8px;
            background: var(--bg-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--pass), var(--highlight));
            transition: width 0.3s;
        }

        @media (max-width: 600px) {
            .header-controls {
                width: 100%;
            }

            .header-controls button {
                flex: 1;
            }
        }
    </style>
    <script src="lib/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Differential Probe - Test Runner</h1>
            <div class="header-controls">
                <button onclick="saveToFile()" class="btn-primary">Save Data</button>
                <button onclick="loadFromFile()">Load Data</button>
                <span id="save-indicator" class="save-indicator saved">✓ Saved</span>
                <button onclick="saveDefinitions()" id="save-defs-btn">Save Definitions</button>
                <button onclick="exportPDF()">Export PDF</button>
                <button onclick="clearAllData()" style="background: var(--fail);">Clear All</button>
            </div>
        </header>

        <div class="dut-info">
            <div>
                <label>Serial Number</label>
                <input type="text" id="dut-serial" placeholder="Enter serial number" onchange="saveDutInfo()">
            </div>
            <div>
                <label>Tester Name</label>
                <input type="text" id="dut-tester" placeholder="Enter tester name" onchange="saveDutInfo()">
            </div>
            <div>
                <label>Test Date</label>
                <input type="date" id="dut-date" onchange="saveDutInfo()">
            </div>
            <div>
                <label>Build Revision</label>
                <input type="text" id="dut-revision" placeholder="e.g., R1" onchange="saveDutInfo()">
            </div>
        </div>

        <div class="summary-bar">
            <div class="summary-stats">
                <div class="summary-stat">
                    <div class="summary-stat-value pass" id="total-pass">0</div>
                    <div class="summary-stat-label">Passed</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value fail" id="total-fail">0</div>
                    <div class="summary-stat-label">Failed</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value pending" id="total-pending">0</div>
                    <div class="summary-stat-label">Pending</div>
                </div>
            </div>
            <div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem;">
                    Progress: <span id="progress-percent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div id="test-categories"></div>
    </div>

    <div class="modal" id="import-modal">
        <div class="modal-content">
            <h3>Import Test Data</h3>
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem;">Load from file:</label>
                <input type="file" id="import-file" accept=".json" onchange="importFromFile(this)" style="width: 100%;">
            </div>
            <div style="margin-bottom: 0.5rem;">Or paste JSON data:</div>
            <textarea id="import-data" placeholder="Paste JSON data here..."></textarea>
            <div class="modal-actions">
                <button onclick="hideImportModal()">Cancel</button>
                <button class="primary" onclick="importData()">Import from Text</button>
            </div>
        </div>
    </div>

    <div class="lightbox" id="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close">&times;</span>
        <img id="lightbox-img" src="" alt="Test image">
    </div>

    <div class="add-test-modal" id="add-test-modal">
        <div class="add-test-form">
            <h3>
                <span id="add-test-title">Add New Test</span>
                <button onclick="hideAddTestModal()" style="background: transparent; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </h3>
            <input type="hidden" id="new-test-category">

            <div class="form-section">
                <h4>Basic Information</h4>
                <div class="form-group">
                    <label>Test ID (e.g., A9, B7)</label>
                    <input type="text" id="new-test-id" placeholder="Enter test ID">
                </div>
                <div class="form-group">
                    <label>Test Name</label>
                    <input type="text" id="new-test-name" placeholder="Enter test name">
                </div>
                <div class="form-group">
                    <label>Objective</label>
                    <textarea id="new-test-objective" placeholder="Describe the test objective..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <h4>Setup Steps</h4>
                <div class="dynamic-list" id="setup-list"></div>
                <button class="add-list-item-btn" onclick="addSetupItem()">+ Add Setup Step</button>
            </div>

            <div class="form-section">
                <h4>Procedure Steps</h4>
                <div class="dynamic-list" id="procedure-list"></div>
                <button class="add-list-item-btn" onclick="addProcedureItem()">+ Add Procedure Step</button>
            </div>

            <div class="form-section">
                <h4>Pass Criteria</h4>
                <div class="criteria-row" id="criteria-header" style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                    <span>Type</span>
                    <span>Parameter</span>
                    <span>Min</span>
                    <span>Typ</span>
                    <span>Max</span>
                    <span></span>
                </div>
                <div id="criteria-list"></div>
                <button class="add-list-item-btn" onclick="addCriteriaItem()">+ Add Criterion</button>
            </div>

            <div class="form-section">
                <h4>Result Fields</h4>
                <button class="add-list-item-btn" onclick="generateFieldsFromCriteria()" style="margin-bottom: 0.75rem; background: var(--highlight); border-style: solid;">Generate from Criteria</button>
                <div class="field-row" style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                    <span>Field ID</span>
                    <span>Label</span>
                    <span>Type</span>
                    <span>Options/Step</span>
                    <span></span>
                </div>
                <div id="fields-list"></div>
                <button class="add-list-item-btn" onclick="addFieldItem()">+ Add Field</button>
            </div>

            <div class="form-actions">
                <button onclick="hideAddTestModal()">Cancel</button>
                <button class="btn-primary" onclick="saveNewTest()">Save Test</button>
            </div>
        </div>
    </div>

    <script>
        // Test definitions - loaded from external file
        let testDefinitions = {};
        const DEFINITIONS_FILE = 'test-definitions.json';

        // Placeholder that gets replaced once definitions load
        const testDefinitionsPlaceholder = {
            "A": {
                name: "Power Supply",
                tests: {
                    "A1": {
                        name: "Power-On from 9V Battery",
                        objective: "Verify probe powers on correctly from 9V battery",
                        setup: [
                            "Connect fresh 9V alkaline battery",
                            "Connect DMM to +5V test point (TP_VCC)",
                            "Connect second DMM to -5V test point (TP_VEE)"
                        ],
                        procedure: [
                            "Verify power LED is OFF with switch in OFF position",
                            "Move switch to ON position",
                            "Record +5V rail voltage",
                            "Record -5V rail voltage",
                            "Verify power LED illuminates GREEN"
                        ],
                        criteria: [
                            { param: "+5V Rail", min: "4.95V", typ: "5.00V", max: "5.05V" },
                            { param: "-5V Rail", min: "-5.05V", typ: "-5.00V", max: "-4.95V" },
                            { param: "Power LED", min: "GREEN", typ: "", max: "" }
                        ],
                        fields: [
                            { id: "v_pos", label: "+5V Rail (V)", type: "number", step: "0.001" },
                            { id: "v_neg", label: "-5V Rail (V)", type: "number", step: "0.001" },
                            { id: "led_status", label: "LED Status", type: "select", options: ["GREEN", "OFF", "Other"] }
                        ]
                    },
                    "A2": {
                        name: "Power-On from LiPo Battery",
                        objective: "Verify probe powers on correctly from LiPo battery (no 9V)",
                        setup: [
                            "Disconnect 9V battery",
                            "Connect charged LiPo battery",
                            "Connect DMMs to +/-5V test points"
                        ],
                        procedure: [
                            "Measure initial LiPo voltage",
                            "Move switch to ON position",
                            "Record +5V and -5V rail voltages",
                            "Verify power LED illuminates"
                        ],
                        criteria: [
                            { param: "+5V Rail", min: "4.90V", typ: "5.00V", max: "5.05V" },
                            { param: "-5V Rail", min: "-5.05V", typ: "-5.00V", max: "-4.90V" }
                        ],
                        fields: [
                            { id: "lipo_v", label: "LiPo Voltage (V)", type: "number", step: "0.01" },
                            { id: "v_pos", label: "+5V Rail (V)", type: "number", step: "0.001" },
                            { id: "v_neg", label: "-5V Rail (V)", type: "number", step: "0.001" }
                        ]
                    },
                    "A3": {
                        name: "Power Supply Noise",
                        objective: "Verify ultra-low noise on power rails",
                        setup: [
                            "Power probe from 9V battery",
                            "Set oscilloscope: AC coupling, 20MHz BW limit, 1mV/div",
                            "Connect scope probe to +5V test point (short ground lead)"
                        ],
                        procedure: [
                            "Measure +5V rail noise (peak-to-peak)",
                            "Repeat for -5V rail",
                            "Note any switching frequency components"
                        ],
                        criteria: [
                            { param: "+5V Noise (p-p)", min: "", typ: "", max: "10mV" },
                            { param: "-5V Noise (p-p)", min: "", typ: "", max: "10mV" }
                        ],
                        fields: [
                            { id: "noise_pos", label: "+5V Noise (mV p-p)", type: "number", step: "0.1" },
                            { id: "noise_neg", label: "-5V Noise (mV p-p)", type: "number", step: "0.1" },
                            { id: "freq_note", label: "Dominant Frequency", type: "text" }
                        ]
                    },
                    "A4": {
                        name: "Supply Current",
                        objective: "Verify quiescent and operating current draw",
                        setup: [
                            "Insert DMM (mA range) in series with 9V battery",
                            "No input signal applied to probe"
                        ],
                        procedure: [
                            "Record quiescent current (no signal, no load)",
                            "Apply 1Vpp 1kHz differential signal, record current",
                            "Calculate power consumption"
                        ],
                        criteria: [
                            { param: "Quiescent Current", min: "", typ: "15mA", max: "30mA" },
                            { param: "Operating Current", min: "", typ: "20mA", max: "50mA" }
                        ],
                        fields: [
                            { id: "i_quiescent", label: "Quiescent (mA)", type: "number", step: "0.1" },
                            { id: "i_operating", label: "Operating (mA)", type: "number", step: "0.1" }
                        ]
                    },
                    "A5": {
                        name: "LiPo Charging",
                        objective: "Verify USB-C charging functionality",
                        setup: [
                            "Connect partially discharged LiPo (3.5-3.8V)",
                            "Connect USB-C 5V power source",
                            "Probe must be OFF"
                        ],
                        procedure: [
                            "Record initial LiPo voltage",
                            "Connect USB-C power",
                            "Verify charging LED (RED)",
                            "Measure charge current if possible",
                            "Wait for complete, record final voltage"
                        ],
                        criteria: [
                            { param: "Charge Current", min: "400mA", typ: "500mA", max: "550mA" },
                            { param: "Final Voltage", min: "4.15V", typ: "4.20V", max: "4.25V" }
                        ],
                        fields: [
                            { id: "v_initial", label: "Initial LiPo (V)", type: "number", step: "0.01" },
                            { id: "i_charge", label: "Charge Current (mA)", type: "number", step: "1" },
                            { id: "v_final", label: "Final LiPo (V)", type: "number", step: "0.01" },
                            { id: "charge_time", label: "Charge Time (min)", type: "number", step: "1" }
                        ]
                    },
                    "A6": {
                        name: "Battery Switchover",
                        objective: "Verify automatic switching between 9V and LiPo",
                        setup: [
                            "Connect both 9V battery and charged LiPo",
                            "Monitor +5V rail with DMM",
                            "Power ON the probe"
                        ],
                        procedure: [
                            "Record +5V with both batteries",
                            "Disconnect 9V while monitoring",
                            "Verify no dropout",
                            "Reconnect 9V, verify smooth transition"
                        ],
                        criteria: [
                            { param: "Switchover", min: "", typ: "No dropout", max: "" },
                            { param: "+5V stability", min: "", typ: "", max: "±50mV" }
                        ],
                        fields: [
                            { id: "v_both", label: "+5V Both Batteries (V)", type: "number", step: "0.001" },
                            { id: "v_lipo_only", label: "+5V LiPo Only (V)", type: "number", step: "0.001" },
                            { id: "glitch", label: "Glitch Observed", type: "select", options: ["None", "Minor", "Significant"] }
                        ]
                    },
                    "A7": {
                        name: "Low Battery Operation",
                        objective: "Verify operation down to minimum LiPo voltage",
                        setup: [
                            "Use adjustable supply to simulate LiPo",
                            "Monitor +5V rail and input voltage"
                        ],
                        procedure: [
                            "Starting from 4.2V, reduce in 0.1V steps",
                            "Record +5V at each step",
                            "Continue until shutdown or out of spec",
                            "Record cutoff voltage"
                        ],
                        criteria: [
                            { param: "+5V @ 3.7V input", min: "4.95V", typ: "5.00V", max: "5.05V" },
                            { param: "+5V @ 3.3V input", min: "4.90V", typ: "", max: "5.05V" }
                        ],
                        fields: [
                            { id: "v5_at_42", label: "+5V @ 4.2V in", type: "number", step: "0.001" },
                            { id: "v5_at_37", label: "+5V @ 3.7V in", type: "number", step: "0.001" },
                            { id: "v5_at_33", label: "+5V @ 3.3V in", type: "number", step: "0.001" },
                            { id: "cutoff_v", label: "Cutoff Voltage (V)", type: "number", step: "0.01" }
                        ]
                    },
                    "A8": {
                        name: "9V Battery Range",
                        objective: "Verify operation across 9V battery voltage range",
                        setup: [
                            "Use adjustable power supply instead of 9V battery",
                            "Monitor +5V rail"
                        ],
                        procedure: [
                            "Set supply to 9.0V, record +5V",
                            "Reduce to 7.5V (depleted), record +5V",
                            "Reduce to 6.0V (minimum), record +5V",
                            "Increase to 9.5V, verify no damage"
                        ],
                        criteria: [
                            { param: "+5V @ 9.0V in", min: "4.95V", typ: "5.00V", max: "5.05V" },
                            { param: "+5V @ 6.0V in", min: "4.90V", typ: "", max: "5.05V" }
                        ],
                        fields: [
                            { id: "v5_at_90", label: "+5V @ 9.0V in", type: "number", step: "0.001" },
                            { id: "v5_at_75", label: "+5V @ 7.5V in", type: "number", step: "0.001" },
                            { id: "v5_at_60", label: "+5V @ 6.0V in", type: "number", step: "0.001" }
                        ]
                    }
                }
            },
            "B": {
                name: "DC Performance",
                tests: {
                    "B1": {
                        name: "DC Attenuation Ratio",
                        objective: "Verify 10:1 attenuation ratio at DC",
                        setup: [
                            "Connect adjustable DC supply to probe inputs",
                            "Connect DMM #1 to measure input differential",
                            "Connect DMM #2 to probe output (BNC)"
                        ],
                        procedure: [
                            "Apply +1.000V differential",
                            "Record output voltage",
                            "Repeat for +5V, +10V, -5V, -10V",
                            "Calculate attenuation ratio"
                        ],
                        criteria: [
                            { param: "Ratio @ 1V", min: "9.9:1", typ: "10.0:1", max: "10.1:1" },
                            { param: "Ratio @ 10V", min: "9.9:1", typ: "10.0:1", max: "10.1:1" }
                        ],
                        fields: [
                            { id: "out_1v", label: "Output @ 1V in (mV)", type: "number", step: "0.1" },
                            { id: "out_5v", label: "Output @ 5V in (mV)", type: "number", step: "0.1" },
                            { id: "out_10v", label: "Output @ 10V in (mV)", type: "number", step: "0.1" },
                            { id: "ratio_avg", label: "Average Ratio", type: "number", step: "0.01" }
                        ]
                    },
                    "B2": {
                        name: "DC Offset",
                        objective: "Measure DC offset with inputs shorted",
                        setup: [
                            "Short both inputs to probe ground",
                            "Connect DMM to probe output"
                        ],
                        procedure: [
                            "Allow probe to warm up 5 minutes",
                            "Record output DC voltage",
                            "Repeat after 15 minutes"
                        ],
                        criteria: [
                            { param: "DC Offset", min: "", typ: "0mV", max: "±10mV" },
                            { param: "Drift (15 min)", min: "", typ: "", max: "±2mV" }
                        ],
                        fields: [
                            { id: "offset_5min", label: "Offset @ 5min (mV)", type: "number", step: "0.1" },
                            { id: "offset_15min", label: "Offset @ 15min (mV)", type: "number", step: "0.1" }
                        ]
                    },
                    "B3": {
                        name: "Input Impedance",
                        objective: "Verify 10MΩ input impedance",
                        setup: [
                            "Connect 1MΩ precision resistor in series with INPUT_POS",
                            "Apply 10V DC through the resistor",
                            "Measure voltage at INPUT_POS"
                        ],
                        procedure: [
                            "Without probe: measure voltage (should be 10V)",
                            "With probe: measure voltage at INPUT_POS",
                            "Calculate input impedance"
                        ],
                        criteria: [
                            { param: "Input Impedance", min: "9MΩ", typ: "10MΩ", max: "11MΩ" }
                        ],
                        fields: [
                            { id: "v_measured", label: "V at INPUT_POS (V)", type: "number", step: "0.001" },
                            { id: "r_input", label: "Calculated Rin (MΩ)", type: "number", step: "0.1" }
                        ]
                    },
                    "B4": {
                        name: "Maximum Input Voltage",
                        objective: "Verify operation at maximum rated differential input",
                        setup: [
                            "Use two power supplies to create ±25V (50V diff)",
                            "Connect through 100kΩ current-limiting resistors",
                            "Monitor output on scope"
                        ],
                        procedure: [
                            "Slowly increase differential from 0 to ±25V",
                            "Verify output tracks correctly (±2.5V)",
                            "Verify no clipping or distortion",
                            "Verify probe survives"
                        ],
                        criteria: [
                            { param: "+50V input", min: "", typ: "+5V output", max: "" },
                            { param: "-50V input", min: "", typ: "-5V output", max: "" }
                        ],
                        fields: [
                            { id: "out_pos50", label: "Output @ +50V in (V)", type: "number", step: "0.01" },
                            { id: "out_neg50", label: "Output @ -50V in (V)", type: "number", step: "0.01" },
                            { id: "clipping", label: "Clipping", type: "select", options: ["None", "Minor", "Significant"] }
                        ]
                    },
                    "B5": {
                        name: "Common Mode DC",
                        objective: "Verify operation with common mode DC offset",
                        setup: [
                            "Apply common mode voltage to both inputs",
                            "Apply small differential on top",
                            "Monitor output"
                        ],
                        procedure: [
                            "Set CM to +5V, apply 1V differential",
                            "Verify output = 100mV (CM rejected)",
                            "Repeat for CM = -5V, 0V, +10V"
                        ],
                        criteria: [
                            { param: "Output @ CM=5V", min: "95mV", typ: "100mV", max: "105mV" },
                            { param: "Output @ CM=10V", min: "95mV", typ: "100mV", max: "105mV" }
                        ],
                        fields: [
                            { id: "out_cm0", label: "Output @ CM=0V (mV)", type: "number", step: "0.1" },
                            { id: "out_cm5", label: "Output @ CM=5V (mV)", type: "number", step: "0.1" },
                            { id: "out_cm10", label: "Output @ CM=10V (mV)", type: "number", step: "0.1" }
                        ]
                    },
                    "B6": {
                        name: "Channel Balance",
                        objective: "Verify positive and negative channels are matched",
                        setup: [
                            "Apply +5V to INPUT_POS only (NEG grounded)",
                            "Record output",
                            "Swap: apply +5V to INPUT_NEG only"
                        ],
                        procedure: [
                            "INPUT_POS = +5V, INPUT_NEG = GND",
                            "Record output",
                            "INPUT_POS = GND, INPUT_NEG = +5V",
                            "Record output, calculate mismatch"
                        ],
                        criteria: [
                            { param: "Channel Mismatch", min: "", typ: "", max: "1%" }
                        ],
                        fields: [
                            { id: "out_pos", label: "Output +5V on POS (mV)", type: "number", step: "0.1" },
                            { id: "out_neg", label: "Output +5V on NEG (mV)", type: "number", step: "0.1" },
                            { id: "mismatch", label: "Mismatch (%)", type: "number", step: "0.01" }
                        ]
                    }
                }
            },
            "C": {
                name: "AC Performance",
                tests: {
                    "C1": {
                        name: "Frequency Response",
                        objective: "Verify flat frequency response (10Hz - 10MHz)",
                        setup: [
                            "Connect function generator to probe inputs",
                            "Set generator to 1Vpp sine wave",
                            "Connect output to scope with 50Ω termination"
                        ],
                        procedure: [
                            "Measure output amplitude at each frequency",
                            "Calculate gain relative to 1kHz reference",
                            "Plot frequency response"
                        ],
                        criteria: [
                            { param: "10Hz - 1MHz", min: "", typ: "", max: "±0.5dB" },
                            { param: "1MHz - 10MHz", min: "", typ: "", max: "±1.0dB" }
                        ],
                        fields: [
                            { id: "out_1k", label: "Output @ 1kHz (mV)", type: "number", step: "0.1" },
                            { id: "out_100k", label: "Output @ 100kHz (mV)", type: "number", step: "0.1" },
                            { id: "out_1M", label: "Output @ 1MHz (mV)", type: "number", step: "0.1" },
                            { id: "out_10M", label: "Output @ 10MHz (mV)", type: "number", step: "0.1" },
                            { id: "flatness", label: "Flatness (dB)", type: "number", step: "0.1" }
                        ]
                    },
                    "C2": {
                        name: "Step Response",
                        objective: "Verify transient response and compensation",
                        setup: [
                            "Set function generator to 1kHz square wave, 1Vpp",
                            "View output on scope, 1µs/div"
                        ],
                        procedure: [
                            "Observe rising edge response",
                            "Check for overshoot, ringing",
                            "Measure rise time (10%-90%)"
                        ],
                        criteria: [
                            { param: "Overshoot", min: "", typ: "", max: "5%" },
                            { param: "Rise time", min: "", typ: "", max: "3.5ns" }
                        ],
                        fields: [
                            { id: "overshoot", label: "Overshoot (%)", type: "number", step: "0.1" },
                            { id: "undershoot", label: "Undershoot (%)", type: "number", step: "0.1" },
                            { id: "rise_time", label: "Rise Time (ns)", type: "number", step: "0.1" },
                            { id: "ringing", label: "Ringing", type: "select", options: ["None", "Minor", "Significant"] }
                        ]
                    },
                    "C3": {
                        name: "Compensation Adjustment",
                        objective: "Optimize frequency compensation (C1/C3) and AC CMRR (C2/C4)",
                        setup: [
                            "Apply 1MHz square wave, 1Vpp differential",
                            "Monitor output on scope (use BNC output)",
                            "Have non-metallic adjustment tool ready"
                        ],
                        procedure: [
                            "STEP 1 - Differential Response:",
                            "1a. Set C2 to middle (~7pF), adjust C1 for flat square wave",
                            "1b. Set C4 to middle (~7pF), adjust C3 for flat square wave",
                            "1c. Verify 10MHz amplitude matches 100kHz (±5%)",
                            "STEP 2 - AC CMRR Optimization:",
                            "2a. Connect both inputs together (CM mode)",
                            "2b. Apply 1MHz, 1Vpp sine wave",
                            "2c. Adjust C2/C4 to minimize CM output (<15mV)",
                            "2d. Re-verify differential response is still flat"
                        ],
                        criteria: [
                            { param: "Square wave", min: "", typ: "Flat top, no overshoot", max: "" },
                            { param: "CM output @ 1MHz", min: "", typ: "", max: "15mV" }
                        ],
                        fields: [
                            { id: "c1_setting", label: "C1 Setting (turns)", type: "text" },
                            { id: "c2_setting", label: "C2 Setting (turns)", type: "text" },
                            { id: "c3_setting", label: "C3 Setting (turns)", type: "text" },
                            { id: "c4_setting", label: "C4 Setting (turns)", type: "text" },
                            { id: "diff_quality", label: "Differential Quality", type: "select", options: ["Excellent", "Good", "Needs work"] },
                            { id: "cm_output", label: "CM Output @ 1MHz (mV)", type: "number", step: "0.1" },
                            { id: "final_check", label: "Diff still flat after CM trim?", type: "select", options: ["Yes", "No - iterate"] }
                        ]
                    },
                    "C4": {
                        name: "Phase Response",
                        objective: "Verify minimal phase shift",
                        setup: [
                            "Split generator output to scope CH1 and probe",
                            "Probe output to CH2",
                            "Measure phase difference"
                        ],
                        procedure: [
                            "Measure phase at 1kHz, 100kHz, 1MHz, 10MHz"
                        ],
                        criteria: [
                            { param: "Phase @ 1kHz", min: "", typ: "", max: "±2°" },
                            { param: "Phase @ 10MHz", min: "", typ: "", max: "±30°" }
                        ],
                        fields: [
                            { id: "phase_1k", label: "Phase @ 1kHz (°)", type: "number", step: "0.1" },
                            { id: "phase_100k", label: "Phase @ 100kHz (°)", type: "number", step: "0.1" },
                            { id: "phase_1M", label: "Phase @ 1MHz (°)", type: "number", step: "0.1" },
                            { id: "phase_10M", label: "Phase @ 10MHz (°)", type: "number", step: "0.1" }
                        ]
                    },
                    "C5": {
                        name: "Slew Rate",
                        objective: "Measure maximum slew rate",
                        setup: [
                            "Apply fast edge signal",
                            "Use maximum input amplitude (10V diff)"
                        ],
                        procedure: [
                            "Measure output rise time for large signal",
                            "Calculate slew rate: SR = ΔV / Δt"
                        ],
                        criteria: [
                            { param: "Slew Rate", min: "100 V/µs", typ: "", max: "" }
                        ],
                        fields: [
                            { id: "delta_v", label: "ΔV (V)", type: "number", step: "0.01" },
                            { id: "delta_t", label: "Δt (ns)", type: "number", step: "0.1" },
                            { id: "slew_rate", label: "Slew Rate (V/µs)", type: "number", step: "1" }
                        ]
                    },
                    "C6": {
                        name: "Output Drive",
                        objective: "Verify probe can drive 50Ω load",
                        setup: [
                            "Connect probe output to 50Ω termination",
                            "Apply 2Vpp differential input"
                        ],
                        procedure: [
                            "Measure output with 50Ω load",
                            "Measure output with 1MΩ load (high-Z)",
                            "Calculate output impedance"
                        ],
                        criteria: [
                            { param: "50Ω load output", min: "90%", typ: "", max: "" }
                        ],
                        fields: [
                            { id: "out_1M", label: "Output @ 1MΩ (mV)", type: "number", step: "0.1" },
                            { id: "out_50", label: "Output @ 50Ω (mV)", type: "number", step: "0.1" },
                            { id: "z_out", label: "Calculated Zout (Ω)", type: "number", step: "0.1" }
                        ]
                    },
                    "C7": {
                        name: "Harmonic Distortion",
                        objective: "Verify low distortion at 1MHz",
                        setup: [
                            "Apply 1MHz sine wave, 2Vpp differential",
                            "View output on scope in FFT mode"
                        ],
                        procedure: [
                            "Identify fundamental (1MHz)",
                            "Measure 2nd and 3rd harmonic levels"
                        ],
                        criteria: [
                            { param: "2nd Harmonic", min: "", typ: "", max: "-50 dBc" },
                            { param: "3rd Harmonic", min: "", typ: "", max: "-50 dBc" }
                        ],
                        fields: [
                            { id: "fundamental", label: "Fundamental (dBV)", type: "number", step: "0.1" },
                            { id: "h2", label: "2nd Harmonic (dBc)", type: "number", step: "0.1" },
                            { id: "h3", label: "3rd Harmonic (dBc)", type: "number", step: "0.1" }
                        ]
                    }
                }
            },
            "D": {
                name: "Common Mode Rejection",
                tests: {
                    "D1": {
                        name: "CMRR at DC (Resistor Matching)",
                        objective: "Measure DC common mode rejection - depends on resistor matching only (NOT adjustable with trimmers)",
                        setup: [
                            "Connect both inputs together (INPUT_POS = INPUT_NEG)",
                            "Apply common mode DC voltage",
                            "Use high-resolution DMM to measure output"
                        ],
                        procedure: [
                            "Apply +2V CM, measure output",
                            "Apply +5V CM, measure output",
                            "Apply -5V CM, measure output",
                            "Calculate CMRR = 20×log10(Vcm/Vout)",
                            "NOTE: DC CMRR depends on resistor matching - cannot be trimmed!"
                        ],
                        criteria: [
                            { param: "CMRR @ DC", min: "60 dB", typ: "", max: "" },
                            { param: "DC Output (5V CM)", min: "", typ: "", max: "5mV" }
                        ],
                        fields: [
                            { id: "out_pos2", label: "Output @ +2V CM (mV)", type: "number", step: "0.01" },
                            { id: "out_pos5", label: "Output @ +5V CM (mV)", type: "number", step: "0.01" },
                            { id: "out_neg5", label: "Output @ -5V CM (mV)", type: "number", step: "0.01" },
                            { id: "cmrr", label: "CMRR (dB)", type: "number", step: "0.1" }
                        ]
                    },
                    "D2": {
                        name: "CMRR at 1kHz",
                        objective: "Measure CMRR at audio frequency",
                        setup: [
                            "Connect both inputs together",
                            "Apply 5Vpp 1kHz sine wave"
                        ],
                        procedure: [
                            "Measure output amplitude",
                            "Calculate CMRR"
                        ],
                        criteria: [
                            { param: "CMRR @ 1kHz", min: "70 dB", typ: "", max: "" }
                        ],
                        fields: [
                            { id: "cm_input", label: "CM Input (Vpp)", type: "number", step: "0.1" },
                            { id: "output", label: "Output (mVpp)", type: "number", step: "0.01" },
                            { id: "cmrr", label: "CMRR (dB)", type: "number", step: "0.1" }
                        ]
                    },
                    "D3": {
                        name: "CMRR at 1MHz (Adjustable with C2/C4)",
                        objective: "Measure and optimize high-frequency CMRR using C2/C4 trimmers",
                        setup: [
                            "Connect both inputs together",
                            "Apply 1Vpp 1MHz sine wave (common mode)",
                            "Monitor output on scope"
                        ],
                        procedure: [
                            "Measure output amplitude (before adjustment)",
                            "If CMRR < 60dB, adjust C2 slightly to minimize output",
                            "Adjust C4 slightly to minimize output",
                            "Re-check differential response is still flat",
                            "Measure final output amplitude",
                            "Calculate CMRR = 20×log10(Vcm/Vout)"
                        ],
                        criteria: [
                            { param: "CMRR @ 1MHz", min: "60 dB", typ: "", max: "" },
                            { param: "CM Output (1V in)", min: "", typ: "", max: "15mV" }
                        ],
                        fields: [
                            { id: "cm_input", label: "CM Input (Vpp)", type: "number", step: "0.1" },
                            { id: "output_before", label: "Output before trim (mVpp)", type: "number", step: "0.01" },
                            { id: "output_after", label: "Output after trim (mVpp)", type: "number", step: "0.01" },
                            { id: "c2_adjust", label: "C2 adjustment (turns)", type: "text" },
                            { id: "c4_adjust", label: "C4 adjustment (turns)", type: "text" },
                            { id: "cmrr", label: "Final CMRR (dB)", type: "number", step: "0.1" },
                            { id: "diff_ok", label: "Diff response still flat?", type: "select", options: ["Yes", "No - re-iterate"] }
                        ]
                    },
                    "D4": {
                        name: "CMRR at 10MHz",
                        objective: "Measure CMRR at maximum generator frequency",
                        setup: [
                            "Connect both inputs together",
                            "Apply 5Vpp 10MHz sine wave"
                        ],
                        procedure: [
                            "Measure output amplitude",
                            "Calculate CMRR"
                        ],
                        criteria: [
                            { param: "CMRR @ 10MHz", min: "50 dB", typ: "", max: "" }
                        ],
                        fields: [
                            { id: "cm_input", label: "CM Input (Vpp)", type: "number", step: "0.1" },
                            { id: "output", label: "Output (mVpp)", type: "number", step: "0.01" },
                            { id: "cmrr", label: "CMRR (dB)", type: "number", step: "0.1" }
                        ]
                    }
                }
            },
            "E": {
                name: "Input Protection",
                tests: {
                    "E1": {
                        name: "TVS Clamping",
                        objective: "Verify TVS diodes clamp overvoltage",
                        setup: [
                            "Apply slowly increasing voltage through 10kΩ resistor",
                            "Monitor voltage at attenuator output"
                        ],
                        procedure: [
                            "Increase input voltage slowly",
                            "Note voltage where clamping begins",
                            "Verify clamp voltage within spec"
                        ],
                        criteria: [
                            { param: "Clamp voltage", min: "5.5V", typ: "", max: "6.5V" }
                        ],
                        fields: [
                            { id: "clamp_start", label: "Clamping Starts (V input)", type: "number", step: "0.1" },
                            { id: "clamp_v", label: "Clamp Voltage (V)", type: "number", step: "0.01" }
                        ]
                    },
                    "E2": {
                        name: "ESD Survival",
                        objective: "Verify probe survives ESD events",
                        setup: [
                            "Record initial DC attenuation ratio",
                            "Prepare ESD source"
                        ],
                        procedure: [
                            "Apply ±2kV contact discharge",
                            "Verify probe functions",
                            "Re-measure attenuation"
                        ],
                        criteria: [
                            { param: "Post-ESD function", min: "", typ: "Normal", max: "" },
                            { param: "Attenuation change", min: "", typ: "", max: "<0.5%" }
                        ],
                        fields: [
                            { id: "ratio_pre", label: "Pre-ESD Ratio", type: "number", step: "0.01" },
                            { id: "ratio_post", label: "Post-ESD Ratio", type: "number", step: "0.01" },
                            { id: "functional", label: "Functional", type: "select", options: ["Yes", "No"] }
                        ]
                    },
                    "E3": {
                        name: "Reverse Polarity",
                        objective: "Verify probe survives reversed battery",
                        setup: [
                            "Prepare reversed polarity battery connection"
                        ],
                        procedure: [
                            "Briefly connect reversed battery (1 sec)",
                            "Disconnect immediately",
                            "Connect correctly, verify operation"
                        ],
                        criteria: [
                            { param: "Post-reverse function", min: "", typ: "Normal", max: "" }
                        ],
                        fields: [
                            { id: "duration", label: "Duration (sec)", type: "number", step: "0.1" },
                            { id: "functional", label: "Post-test Function", type: "select", options: ["Normal", "Damaged"] }
                        ]
                    }
                }
            }
        };

        // Data storage
        let testData = {
            dutInfo: {},
            results: {}  // { testId: [{ timestamp, status, values, notes }] }
        };

        // File handle for direct file access (File System Access API)
        let fileHandle = null;
        let fileHandleDefinitions = null;
        let hasUnsavedChanges = false;
        const DATA_FILE = 'test-data.json';

        // Load test definitions from file
        async function loadTestDefinitions() {
            try {
                const response = await fetch(DEFINITIONS_FILE);
                if (response.ok) {
                    testDefinitions = await response.json();
                    console.log('Loaded test definitions from', DEFINITIONS_FILE);
                    return true;
                }
            } catch (e) {
                console.log('Could not load definitions from file, using embedded:', e.message);
            }
            // Fall back to embedded definitions
            testDefinitions = testDefinitionsPlaceholder;
            return false;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadTestDefinitions();
            await loadData();
            renderTests();
            updateSummary();
            updateSaveIndicator();

            // Set default date
            if (!document.getElementById('dut-date').value) {
                document.getElementById('dut-date').value = new Date().toISOString().split('T')[0];
            }

            // Warn before leaving with unsaved changes
            window.addEventListener('beforeunload', (e) => {
                if (hasUnsavedChanges || hasDefinitionChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });

        async function loadData() {
            // Try to load from file first (if served via web server)
            try {
                const response = await fetch(DATA_FILE);
                if (response.ok) {
                    const data = await response.json();
                    if (data && (data.dutInfo || data.results)) {
                        testData = data;
                        applyLoadedData();
                        console.log('Loaded data from', DATA_FILE);
                        return;
                    }
                }
            } catch (e) {
                console.log('Could not load from file, trying localStorage:', e.message);
            }

            // Fall back to localStorage
            const saved = localStorage.getItem('diffprobe-test-data');
            if (saved) {
                testData = JSON.parse(saved);
                applyLoadedData();
                console.log('Loaded data from localStorage');
            }
        }

        function applyLoadedData() {
            document.getElementById('dut-serial').value = testData.dutInfo?.serial || '';
            document.getElementById('dut-tester').value = testData.dutInfo?.tester || '';
            document.getElementById('dut-date').value = testData.dutInfo?.date || '';
            document.getElementById('dut-revision').value = testData.dutInfo?.revision || '';
        }

        function saveData() {
            // Always save to localStorage as backup
            localStorage.setItem('diffprobe-test-data', JSON.stringify(testData));
            hasUnsavedChanges = true;
            updateSaveIndicator();
            updateSummary();
        }

        function updateSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            if (indicator) {
                indicator.textContent = hasUnsavedChanges ? '● Unsaved changes' : '✓ Saved';
                indicator.className = 'save-indicator ' + (hasUnsavedChanges ? 'unsaved' : 'saved');
            }
        }

        async function saveToFile() {
            // Try File System Access API first (Chrome/Edge)
            if ('showSaveFilePicker' in window) {
                try {
                    if (!fileHandle) {
                        fileHandle = await window.showSaveFilePicker({
                            suggestedName: DATA_FILE,
                            types: [{
                                description: 'JSON Files',
                                accept: { 'application/json': ['.json'] }
                            }]
                        });
                    }
                    const writable = await fileHandle.createWritable();
                    await writable.write(JSON.stringify(testData, null, 2));
                    await writable.close();
                    hasUnsavedChanges = false;
                    updateSaveIndicator();
                    console.log('Saved to file via File System Access API');
                    return;
                } catch (e) {
                    if (e.name !== 'AbortError') {
                        console.error('File System Access API error:', e);
                    }
                }
            }

            // Fall back to download
            downloadDataFile();
        }

        function downloadDataFile() {
            const dataStr = JSON.stringify(testData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = DATA_FILE;
            a.click();
            URL.revokeObjectURL(url);
            hasUnsavedChanges = false;
            updateSaveIndicator();
            alert('Data file downloaded. Move it to the docs/ folder to persist changes.');
        }

        async function loadFromFile() {
            // Try File System Access API first
            if ('showOpenFilePicker' in window) {
                try {
                    const [handle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'JSON Files',
                            accept: { 'application/json': ['.json'] }
                        }]
                    });
                    fileHandle = handle;
                    const file = await handle.getFile();
                    const content = await file.text();
                    testData = JSON.parse(content);
                    applyLoadedData();
                    saveData(); // Update localStorage
                    hasUnsavedChanges = false;
                    renderTests();
                    updateSaveIndicator();
                    console.log('Loaded from file via File System Access API');
                    return;
                } catch (e) {
                    if (e.name !== 'AbortError') {
                        console.error('File System Access API error:', e);
                    }
                    return;
                }
            }

            // Fall back to file input
            showImportModal();
        }

        function saveDutInfo() {
            testData.dutInfo = {
                serial: document.getElementById('dut-serial').value,
                tester: document.getElementById('dut-tester').value,
                date: document.getElementById('dut-date').value,
                revision: document.getElementById('dut-revision').value
            };
            saveData();
        }

        function renderTests() {
            const container = document.getElementById('test-categories');
            container.innerHTML = '';

            for (const [catId, category] of Object.entries(testDefinitions)) {
                const catEl = document.createElement('div');
                catEl.className = 'category';

                const stats = getCategoryStats(catId);

                catEl.innerHTML = `
                    <div class="category-header" onclick="toggleCategory('${catId}')">
                        <h2>${catId}. ${category.name}</h2>
                        <div class="category-stats">
                            <span class="stat-badge stat-pass">${stats.pass}</span>
                            <span class="stat-badge stat-fail">${stats.fail}</span>
                            <span class="stat-badge stat-pending">${stats.pending}</span>
                        </div>
                    </div>
                    <div class="category-tests" id="cat-${catId}">
                        ${Object.entries(category.tests).map(([testId, test]) => renderTest(testId, test)).join('')}
                        <button class="add-test-btn" onclick="event.stopPropagation(); showAddTestModal('${catId}')">+ Add Test to ${category.name}</button>
                    </div>
                `;

                container.appendChild(catEl);
            }
        }

        function renderTest(testId, test) {
            const lastResult = getLastResult(testId);
            const statusClass = lastResult ? lastResult.status : '';
            const lastRun = lastResult ? formatDate(lastResult.timestamp) : 'Not tested';

            return `
                <div class="test-item" id="test-${testId}">
                    <div class="test-header" onclick="toggleTest('${testId}')">
                        <div class="test-title">
                            <span class="test-id">${testId}</span>
                            <span class="test-name">${test.name}</span>
                            <button class="delete-test-btn" onclick="event.stopPropagation(); deleteTest('${testId}')" title="Delete test">Delete</button>
                        </div>
                        <div class="test-status">
                            <span class="last-run">${lastRun}</span>
                            <span class="status-indicator ${statusClass}"></span>
                            <span class="expand-icon">▼</span>
                        </div>
                    </div>
                    <div class="test-content">
                        <div class="test-section">
                            <h4>Objective</h4>
                            <p>${test.objective}</p>
                        </div>
                        <div class="test-section">
                            <h4>Setup</h4>
                            <ul>${test.setup.map(s => `<li>${s}</li>`).join('')}</ul>
                        </div>
                        <div class="test-section">
                            <h4>Procedure</h4>
                            <ul>${test.procedure.map(p => `<li>${p}</li>`).join('')}</ul>
                        </div>
                        <div class="test-section">
                            <h4>Pass Criteria</h4>
                            <table>
                                <tr><th>Parameter</th><th>Min</th><th>Typ</th><th>Max</th></tr>
                                ${test.criteria.map(c => `<tr><td>${c.param}</td><td>${c.min}</td><td>${c.typ}</td><td>${c.max}</td></tr>`).join('')}
                            </table>
                        </div>
                        <div class="run-test-form">
                            <h4>Record Test Result</h4>
                            <div class="form-row">
                                ${test.fields.map(f => renderField(testId, f)).join('')}
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea id="${testId}-notes" placeholder="Optional notes..."></textarea>
                            </div>
                            <div class="image-upload-group">
                                <label>Attach Image (optional)</label>
                                <div class="image-upload-row">
                                    <input type="file" id="${testId}-image" accept="image/*" onchange="previewImage('${testId}')">
                                    <img id="${testId}-preview" class="image-preview" src="" alt="Preview">
                                    <button class="clear-image-btn" id="${testId}-clear" onclick="clearImage('${testId}')">Clear</button>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button onclick="recordResult('${testId}', 'pass')">Pass</button>
                                <button onclick="recordResult('${testId}', 'fail')" style="background: var(--fail)">Fail</button>
                            </div>
                        </div>
                        ${renderHistory(testId)}
                    </div>
                </div>
            `;
        }

        function renderField(testId, field) {
            if (field.type === 'select') {
                return `
                    <div class="form-group">
                        <label>${field.label}</label>
                        <select id="${testId}-${field.id}">
                            ${field.options.map(o => `<option value="${o}">${o}</option>`).join('')}
                        </select>
                    </div>
                `;
            }
            return `
                <div class="form-group">
                    <label>${field.label}</label>
                    <input type="${field.type}" id="${testId}-${field.id}" step="${field.step || ''}">
                </div>
            `;
        }

        function renderHistory(testId) {
            const results = testData.results[testId] || [];
            if (results.length === 0) return '';

            return `
                <div class="history-section">
                    <h4 onclick="toggleHistory('${testId}')">
                        <span class="expand-icon" id="hist-icon-${testId}">▶</span>
                        Test History (${results.length} runs)
                    </h4>
                    <div class="history-list" id="history-${testId}">
                        ${results.slice().reverse().map((r, idx) => renderHistoryItem(r, testId, results.length - 1 - idx)).join('')}
                    </div>
                </div>
            `;
        }

        function renderHistoryItem(result, testId, index) {
            const test = getTestDef(testId);
            const dut = result.dut || {};
            const dutInfo = [
                dut.revision ? `Rev: ${dut.revision}` : '',
                dut.serial ? `S/N: ${dut.serial}` : '',
                dut.tester ? `Tester: ${dut.tester}` : ''
            ].filter(x => x).join(' | ');

            return `
                <div class="history-item">
                    <div class="history-item-header">
                        <span class="history-item-date">${formatDate(result.timestamp)}${dutInfo ? ` <span style="color: var(--text-muted); font-size: 0.85em;">(${dutInfo})</span>` : ''}</span>
                        <div class="history-item-actions">
                            <span class="history-item-status ${result.status}">${result.status.toUpperCase()}</span>
                            <button class="delete-btn" onclick="deleteResult('${testId}', ${index})" title="Delete this test run">×</button>
                        </div>
                    </div>
                    <div class="history-item-values">
                        ${test.fields.map(f => `
                            <div class="history-value">
                                <span class="history-value-label">${f.label}</span>
                                <span class="history-value-data">${result.values[f.id] || '-'}</span>
                            </div>
                        `).join('')}
                    </div>
                    ${result.notes ? `<div style="margin-top: 0.5rem; font-style: italic; color: var(--text-muted);">${result.notes}</div>` : ''}
                    ${result.image ? `<img class="history-thumbnail" src="${result.image}" alt="Test image" onclick="openLightbox(this.src)">` : ''}
                </div>
            `;
        }

        function deleteResult(testId, index) {
            if (confirm('Delete this test run?')) {
                testData.results[testId].splice(index, 1);
                if (testData.results[testId].length === 0) {
                    delete testData.results[testId];
                }
                saveData();
                renderTests();
            }
        }

        function getTestDef(testId) {
            const catId = testId.charAt(0);
            return testDefinitions[catId].tests[testId];
        }

        function getLastResult(testId) {
            const results = testData.results[testId];
            return results && results.length > 0 ? results[results.length - 1] : null;
        }

        function getCategoryStats(catId) {
            const category = testDefinitions[catId];
            let pass = 0, fail = 0, pending = 0;

            for (const testId of Object.keys(category.tests)) {
                const last = getLastResult(testId);
                if (!last) pending++;
                else if (last.status === 'pass') pass++;
                else fail++;
            }

            return { pass, fail, pending };
        }

        function updateSummary() {
            let totalPass = 0, totalFail = 0, totalPending = 0;

            for (const catId of Object.keys(testDefinitions)) {
                const stats = getCategoryStats(catId);
                totalPass += stats.pass;
                totalFail += stats.fail;
                totalPending += stats.pending;
            }

            document.getElementById('total-pass').textContent = totalPass;
            document.getElementById('total-fail').textContent = totalFail;
            document.getElementById('total-pending').textContent = totalPending;

            const total = totalPass + totalFail + totalPending;
            const completed = totalPass + totalFail;
            const percent = total > 0 ? Math.round(completed / total * 100) : 0;

            document.getElementById('progress-percent').textContent = percent + '%';
            document.getElementById('progress-fill').style.width = percent + '%';
        }

        function toggleCategory(catId) {
            const el = document.getElementById('cat-' + catId);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function toggleTest(testId) {
            const el = document.getElementById('test-' + testId);
            el.classList.toggle('expanded');
        }

        function toggleHistory(testId) {
            const el = document.getElementById('history-' + testId);
            const icon = document.getElementById('hist-icon-' + testId);
            el.classList.toggle('visible');
            icon.textContent = el.classList.contains('visible') ? '▼' : '▶';
        }

        // Store pending images per test (populated by previewImage)
        const pendingImages = {};

        function recordResult(testId, status) {
            const test = getTestDef(testId);
            const values = {};

            for (const field of test.fields) {
                const el = document.getElementById(`${testId}-${field.id}`);
                values[field.id] = el.value;
            }

            const notes = document.getElementById(`${testId}-notes`).value;
            const image = pendingImages[testId] || null;

            if (!testData.results[testId]) {
                testData.results[testId] = [];
            }

            testData.results[testId].push({
                timestamp: new Date().toISOString(),
                status,
                values,
                notes,
                image,
                dut: {
                    serial: document.getElementById('dut-serial').value,
                    tester: document.getElementById('dut-tester').value,
                    revision: document.getElementById('dut-revision').value
                }
            });

            // Clear the pending image after recording
            delete pendingImages[testId];

            saveData();
            renderTests();
        }

        function previewImage(testId) {
            const input = document.getElementById(`${testId}-image`);
            const preview = document.getElementById(`${testId}-preview`);
            const clearBtn = document.getElementById(`${testId}-clear`);

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.add('visible');
                    clearBtn.classList.add('visible');
                    pendingImages[testId] = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function clearImage(testId) {
            const input = document.getElementById(`${testId}-image`);
            const preview = document.getElementById(`${testId}-preview`);
            const clearBtn = document.getElementById(`${testId}-clear`);

            input.value = '';
            preview.src = '';
            preview.classList.remove('visible');
            clearBtn.classList.remove('visible');
            delete pendingImages[testId];
        }

        function openLightbox(imageSrc) {
            document.getElementById('lightbox-img').src = imageSrc;
            document.getElementById('lightbox').classList.add('visible');
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('visible');
        }

        function formatDate(isoString) {
            const d = new Date(isoString);
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function exportData() {
            const dataStr = JSON.stringify(testData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diffprobe-test-${testData.dutInfo.serial || 'unknown'}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            const contentWidth = pageWidth - 2 * margin;
            let y = 20;

            const projectName = 'Differential Active Probe';
            const dateStr = new Date().toLocaleDateString();
            const timeStr = new Date().toLocaleTimeString();

            // Helper to add new page if needed
            function checkPage(needed = 20) {
                if (y + needed > 280) {
                    doc.addPage();
                    y = 20;
                }
            }

            // Title
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('Test Report', pageWidth / 2, y, { align: 'center' });
            y += 8;

            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            doc.text(projectName, pageWidth / 2, y, { align: 'center' });
            y += 10;

            // DUT Info
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const dutInfo = testData.dutInfo || {};
            doc.text(`Date: ${dateStr} ${timeStr}`, margin, y);
            y += 5;
            if (dutInfo.revision) {
                doc.text(`Revision: ${dutInfo.revision}`, margin, y);
                y += 5;
            }
            if (dutInfo.serial) {
                doc.text(`Serial Number: ${dutInfo.serial}`, margin, y);
                y += 5;
            }
            if (dutInfo.tester) {
                doc.text(`Tester: ${dutInfo.tester}`, margin, y);
                y += 5;
            }
            y += 5;

            // Summary
            let totalPass = 0, totalFail = 0, totalPending = 0;
            for (const catId of Object.keys(testDefinitions)) {
                for (const testId of Object.keys(testDefinitions[catId].tests)) {
                    const results = testData.results[testId];
                    if (results && results.length > 0) {
                        const last = results[results.length - 1];
                        if (last.status === 'pass') totalPass++;
                        else if (last.status === 'fail') totalFail++;
                    } else {
                        totalPending++;
                    }
                }
            }

            doc.setFillColor(240, 240, 240);
            doc.rect(margin, y, contentWidth, 20, 'F');
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            y += 7;
            doc.text('Summary', margin + 5, y);
            y += 7;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);

            const total = totalPass + totalFail + totalPending;
            const completed = totalPass + totalFail;
            const percent = total > 0 ? Math.round(completed / total * 100) : 0;

            doc.setTextColor(46, 204, 113);
            doc.text(`Passed: ${totalPass}`, margin + 5, y);
            doc.setTextColor(231, 76, 60);
            doc.text(`Failed: ${totalFail}`, margin + 50, y);
            doc.setTextColor(243, 156, 18);
            doc.text(`Pending: ${totalPending}`, margin + 95, y);
            doc.setTextColor(0, 0, 0);
            doc.text(`Progress: ${percent}% (${completed}/${total})`, margin + 145, y);
            y += 15;

            // Test Results by Category
            for (const catId of Object.keys(testDefinitions)) {
                const category = testDefinitions[catId];

                checkPage(25);
                doc.setFillColor(15, 52, 96);
                doc.setTextColor(255, 255, 255);
                doc.rect(margin, y, contentWidth, 8, 'F');
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(`${catId}. ${category.name}`, margin + 3, y + 5.5);
                doc.setTextColor(0, 0, 0);
                y += 12;

                for (const testId of Object.keys(category.tests)) {
                    const test = category.tests[testId];
                    const results = testData.results[testId];
                    const lastResult = results && results.length > 0 ? results[results.length - 1] : null;

                    checkPage(30);

                    // Test ID and name
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${testId}: ${test.name}`, margin, y);

                    // Status badge
                    const status = lastResult ? lastResult.status.toUpperCase() : 'PENDING';
                    if (lastResult?.status === 'pass') {
                        doc.setTextColor(46, 204, 113);
                    } else if (lastResult?.status === 'fail') {
                        doc.setTextColor(231, 76, 60);
                    } else {
                        doc.setTextColor(243, 156, 18);
                    }
                    doc.text(status, pageWidth - margin - 20, y);
                    doc.setTextColor(0, 0, 0);
                    y += 5;

                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);

                    if (lastResult) {
                        // Timestamp
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Tested: ${formatDate(lastResult.timestamp)}`, margin + 5, y);
                        doc.setTextColor(0, 0, 0);
                        y += 4;

                        // Measurement values
                        if (test.fields && test.fields.length > 0) {
                            const valueStrs = test.fields.map(f => {
                                const val = lastResult.values[f.id] || '-';
                                return `${f.label}: ${val}`;
                            });

                            // Split into lines if too long
                            let line = '';
                            for (const vs of valueStrs) {
                                if (line.length + vs.length > 80) {
                                    doc.text(line, margin + 5, y);
                                    y += 4;
                                    line = vs;
                                } else {
                                    line = line ? line + '  |  ' + vs : vs;
                                }
                            }
                            if (line) {
                                doc.text(line, margin + 5, y);
                                y += 4;
                            }
                        }

                        // Notes
                        if (lastResult.notes) {
                            doc.setTextColor(80, 80, 80);
                            const noteLines = doc.splitTextToSize(`Notes: ${lastResult.notes}`, contentWidth - 10);
                            for (const nl of noteLines) {
                                checkPage(5);
                                doc.text(nl, margin + 5, y);
                                y += 4;
                            }
                            doc.setTextColor(0, 0, 0);
                        }
                    } else {
                        doc.setTextColor(100, 100, 100);
                        doc.text('Not tested yet', margin + 5, y);
                        doc.setTextColor(0, 0, 0);
                        y += 4;
                    }

                    y += 4; // Space between tests
                }

                y += 5; // Space between categories
            }

            // Footer
            checkPage(15);
            y += 5;
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text(`Generated by Differential Probe Test Runner - ${dateStr}`, pageWidth / 2, 290, { align: 'center' });

            // Save
            const filename = `DifferentialProbe-TestReport-${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
        }

        function showImportModal() {
            document.getElementById('import-modal').classList.add('visible');
        }

        function hideImportModal() {
            document.getElementById('import-modal').classList.remove('visible');
        }

        function importData() {
            try {
                const dataStr = document.getElementById('import-data').value;
                const imported = JSON.parse(dataStr);
                testData = imported;
                applyLoadedData();
                saveData();
                renderTests();
                hideImportModal();
                alert('Data imported successfully! Remember to click "Save Data" to persist to file.');
            } catch (e) {
                alert('Invalid JSON data: ' + e.message);
            }
        }

        function importFromFile(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        testData = imported;
                        applyLoadedData();
                        saveData();
                        renderTests();
                        hideImportModal();
                        input.value = ''; // Reset file input
                        alert('Data loaded from file! Remember to click "Save Data" to persist changes.');
                    } catch (err) {
                        alert('Invalid JSON file: ' + err.message);
                    }
                };
                reader.readAsText(input.files[0]);
            }
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all test data? This cannot be undone.')) {
                testData = { dutInfo: {}, results: {} };
                saveData();
                document.getElementById('dut-serial').value = '';
                document.getElementById('dut-tester').value = '';
                document.getElementById('dut-revision').value = '';
                renderTests();
            }
        }

        // ============ Test Management Functions ============

        let hasDefinitionChanges = false;

        function updateDefinitionsButton() {
            const btn = document.getElementById('save-defs-btn');
            if (btn) {
                if (hasDefinitionChanges) {
                    btn.classList.add('has-changes');
                    btn.textContent = 'Save Definitions*';
                } else {
                    btn.classList.remove('has-changes');
                    btn.textContent = 'Save Definitions';
                }
            }
        }

        function showAddTestModal(catId) {
            document.getElementById('new-test-category').value = catId;
            document.getElementById('add-test-title').textContent = `Add Test to Category ${catId}`;

            // Clear previous inputs
            document.getElementById('new-test-id').value = '';
            document.getElementById('new-test-name').value = '';
            document.getElementById('new-test-objective').value = '';
            document.getElementById('setup-list').innerHTML = '';
            document.getElementById('procedure-list').innerHTML = '';
            document.getElementById('criteria-list').innerHTML = '';
            document.getElementById('fields-list').innerHTML = '';

            // Suggest next test ID
            const category = testDefinitions[catId];
            const existingIds = Object.keys(category.tests).map(id => parseInt(id.substring(1))).filter(n => !isNaN(n));
            const nextNum = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
            document.getElementById('new-test-id').value = catId + nextNum;

            // Add initial items
            addSetupItem();
            addProcedureItem();
            addCriteriaItem();
            addFieldItem();

            document.getElementById('add-test-modal').classList.add('visible');
        }

        function hideAddTestModal() {
            document.getElementById('add-test-modal').classList.remove('visible');
        }

        function addSetupItem(value = '') {
            const list = document.getElementById('setup-list');
            const idx = list.children.length;
            const item = document.createElement('div');
            item.className = 'dynamic-list-item';
            item.innerHTML = `
                <input type="text" id="setup-${idx}" value="${escapeHtml(value)}" placeholder="Setup step ${idx + 1}...">
                <button onclick="removeListItem(this)">×</button>
            `;
            list.appendChild(item);
        }

        function addProcedureItem(value = '') {
            const list = document.getElementById('procedure-list');
            const idx = list.children.length;
            const item = document.createElement('div');
            item.className = 'dynamic-list-item';
            item.innerHTML = `
                <input type="text" id="procedure-${idx}" value="${escapeHtml(value)}" placeholder="Procedure step ${idx + 1}...">
                <button onclick="removeListItem(this)">×</button>
            `;
            list.appendChild(item);
        }

        function addCriteriaItem(criterion = {}) {
            const list = document.getElementById('criteria-list');
            const idx = list.children.length;
            const item = document.createElement('div');
            // Determine if this is a pass/fail type (no numeric values)
            const isPassFail = criterion.type === 'passfail' ||
                (!criterion.min && !criterion.max && criterion.typ &&
                 (criterion.typ.toLowerCase().includes('pass') ||
                  criterion.typ.toLowerCase().includes('normal') ||
                  criterion.typ.toLowerCase().includes('yes') ||
                  criterion.typ.toLowerCase().includes('no ')));
            item.className = 'criteria-row' + (isPassFail ? ' passfail-mode' : '');
            item.innerHTML = `
                <select onchange="toggleCriteriaType(this)">
                    <option value="numeric" ${!isPassFail ? 'selected' : ''}>Numeric</option>
                    <option value="passfail" ${isPassFail ? 'selected' : ''}>Pass/Fail</option>
                </select>
                <input type="text" placeholder="Parameter" value="${escapeHtml(criterion.param || '')}">
                <span class="numeric-fields">
                    <input type="text" placeholder="Min" value="${escapeHtml(criterion.min || '')}">
                    <input type="text" placeholder="Typ" value="${escapeHtml(criterion.typ || '')}">
                    <input type="text" placeholder="Max" value="${escapeHtml(criterion.max || '')}">
                </span>
                <button onclick="removeListItem(this)" style="padding: 0.25rem 0.5rem; background: var(--fail); border: none; color: white; border-radius: 3px; cursor: pointer;">×</button>
            `;
            list.appendChild(item);
        }

        function toggleCriteriaType(selectEl) {
            const row = selectEl.closest('.criteria-row');
            if (selectEl.value === 'passfail') {
                row.classList.add('passfail-mode');
            } else {
                row.classList.remove('passfail-mode');
            }
        }

        function generateFieldsFromCriteria() {
            const fieldsList = document.getElementById('fields-list');
            fieldsList.innerHTML = ''; // Clear existing fields

            document.querySelectorAll('#criteria-list .criteria-row').forEach((row, idx) => {
                const typeSelect = row.querySelector('select');
                const inputs = row.querySelectorAll('input');
                const param = inputs[0].value.trim();

                if (!param) return;

                // Generate a field ID from the parameter name
                const fieldId = param.toLowerCase()
                    .replace(/[^a-z0-9]+/g, '_')
                    .replace(/^_+|_+$/g, '')
                    .substring(0, 20);

                if (typeSelect.value === 'passfail') {
                    // Pass/Fail criterion -> select field with Pass/Fail options
                    addFieldItem({
                        id: fieldId,
                        label: param,
                        type: 'select',
                        options: ['Pass', 'Fail']
                    });
                } else {
                    // Numeric criterion -> number field
                    addFieldItem({
                        id: fieldId,
                        label: param,
                        type: 'number',
                        step: '0.01'
                    });
                }
            });

            if (fieldsList.children.length === 0) {
                alert('No criteria found. Add criteria first, then generate fields.');
            }
        }

        function addFieldItem(field = {}) {
            const list = document.getElementById('fields-list');
            const idx = list.children.length;
            const item = document.createElement('div');
            item.className = 'field-row';
            item.innerHTML = `
                <input type="text" placeholder="field_id" value="${escapeHtml(field.id || '')}">
                <input type="text" placeholder="Field Label" value="${escapeHtml(field.label || '')}">
                <select onchange="updateFieldOptions(this)">
                    <option value="number" ${field.type === 'number' ? 'selected' : ''}>Number</option>
                    <option value="text" ${field.type === 'text' ? 'selected' : ''}>Text</option>
                    <option value="select" ${field.type === 'select' ? 'selected' : ''}>Select</option>
                </select>
                <input type="text" placeholder="${field.type === 'select' ? 'opt1,opt2,opt3' : 'step (e.g., 0.1)'}" value="${escapeHtml(field.type === 'select' ? (field.options || []).join(',') : (field.step || ''))}">
                <button onclick="removeListItem(this)" style="padding: 0.25rem 0.5rem; background: var(--fail); border: none; color: white; border-radius: 3px; cursor: pointer;">×</button>
            `;
            list.appendChild(item);
        }

        function updateFieldOptions(selectEl) {
            const row = selectEl.closest('.field-row');
            const optionsInput = row.querySelector('input:nth-of-type(2)');
            if (selectEl.value === 'select') {
                optionsInput.placeholder = 'opt1,opt2,opt3';
            } else {
                optionsInput.placeholder = 'step (e.g., 0.1)';
            }
        }

        function removeListItem(btn) {
            btn.closest('.dynamic-list-item, .criteria-row, .field-row').remove();
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        async function saveNewTest() {
            const catId = document.getElementById('new-test-category').value;
            const testId = document.getElementById('new-test-id').value.trim();
            const name = document.getElementById('new-test-name').value.trim();
            const objective = document.getElementById('new-test-objective').value.trim();

            // Validation
            if (!testId) {
                alert('Please enter a Test ID');
                return;
            }
            if (!testId.startsWith(catId)) {
                alert(`Test ID must start with category letter "${catId}"`);
                return;
            }
            if (!name) {
                alert('Please enter a Test Name');
                return;
            }
            if (!objective) {
                alert('Please enter a Test Objective');
                return;
            }

            // Check for duplicate ID
            if (testDefinitions[catId].tests[testId]) {
                alert(`Test ID "${testId}" already exists. Please choose a different ID.`);
                return;
            }

            // Collect setup steps
            const setup = [];
            document.querySelectorAll('#setup-list input').forEach(input => {
                if (input.value.trim()) setup.push(input.value.trim());
            });
            if (setup.length === 0) {
                alert('Please add at least one setup step');
                return;
            }

            // Collect procedure steps
            const procedure = [];
            document.querySelectorAll('#procedure-list input').forEach(input => {
                if (input.value.trim()) procedure.push(input.value.trim());
            });
            if (procedure.length === 0) {
                alert('Please add at least one procedure step');
                return;
            }

            // Collect criteria
            const criteria = [];
            document.querySelectorAll('#criteria-list .criteria-row').forEach(row => {
                const typeSelect = row.querySelector('select');
                const inputs = row.querySelectorAll('input');
                const param = inputs[0].value.trim();
                if (param) {
                    if (typeSelect.value === 'passfail') {
                        // Pass/Fail type - just parameter with empty min/max, typ shows expected
                        criteria.push({
                            param: param,
                            min: '',
                            typ: 'Pass',
                            max: ''
                        });
                    } else {
                        // Numeric type - parameter with min/typ/max
                        const numericInputs = row.querySelectorAll('.numeric-fields input');
                        criteria.push({
                            param: param,
                            min: numericInputs[0]?.value.trim() || '',
                            typ: numericInputs[1]?.value.trim() || '',
                            max: numericInputs[2]?.value.trim() || ''
                        });
                    }
                }
            });
            if (criteria.length === 0) {
                alert('Please add at least one pass criterion');
                return;
            }

            // Collect fields
            const fields = [];
            document.querySelectorAll('#fields-list .field-row').forEach(row => {
                const inputs = row.querySelectorAll('input');
                const id = inputs[0].value.trim();
                const label = inputs[1].value.trim();
                const type = row.querySelector('select').value;
                const optionsStep = inputs[2]?.value.trim() || '';

                if (id && label) {
                    const field = { id, label, type };
                    if (type === 'select') {
                        field.options = optionsStep.split(',').map(o => o.trim()).filter(o => o);
                    } else if (type === 'number' && optionsStep) {
                        field.step = optionsStep;
                    }
                    fields.push(field);
                }
            });
            if (fields.length === 0) {
                alert('Please add at least one result field');
                return;
            }

            // Create the test
            const newTest = {
                name,
                objective,
                setup,
                procedure,
                criteria,
                fields
            };

            // Add to definitions
            testDefinitions[catId].tests[testId] = newTest;

            hideAddTestModal();
            renderTests();
            updateSummary();

            // Auto-save definitions
            await saveDefinitionsAuto();
        }

        async function deleteTest(testId) {
            const catId = testId.charAt(0);
            const test = testDefinitions[catId]?.tests[testId];

            if (!test) {
                alert('Test not found');
                return;
            }

            const hasResults = testData.results[testId] && testData.results[testId].length > 0;
            const message = hasResults
                ? `Delete test "${testId}: ${test.name}"?\n\nWARNING: This test has ${testData.results[testId].length} recorded result(s) that will also be deleted!`
                : `Delete test "${testId}: ${test.name}"?`;

            if (confirm(message)) {
                // Remove from definitions
                delete testDefinitions[catId].tests[testId];

                // Remove any results for this test
                if (testData.results[testId]) {
                    delete testData.results[testId];
                    saveData();
                }

                renderTests();
                updateSummary();

                // Auto-save definitions
                await saveDefinitionsAuto();
            }
        }

        // Auto-save definitions (called when adding/deleting tests)
        async function saveDefinitionsAuto() {
            // Try File System Access API first
            if ('showSaveFilePicker' in window) {
                try {
                    // Request file handle if we don't have one
                    if (!fileHandleDefinitions) {
                        fileHandleDefinitions = await window.showSaveFilePicker({
                            suggestedName: DEFINITIONS_FILE,
                            types: [{
                                description: 'JSON Files',
                                accept: { 'application/json': ['.json'] }
                            }]
                        });
                    }
                    const writable = await fileHandleDefinitions.createWritable();
                    await writable.write(JSON.stringify(testDefinitions, null, 2));
                    await writable.close();
                    hasDefinitionChanges = false;
                    updateDefinitionsButton();
                    console.log('Test definitions saved to file');
                    return true;
                } catch (e) {
                    if (e.name === 'AbortError') {
                        // User cancelled - mark as unsaved
                        hasDefinitionChanges = true;
                        updateDefinitionsButton();
                        alert('File save cancelled. Changes are unsaved - click "Save Definitions" to save later.');
                        return false;
                    }
                    console.error('File System Access API error:', e);
                }
            }

            // Fall back to download
            const dataStr = JSON.stringify(testDefinitions, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = DEFINITIONS_FILE;
            a.click();
            URL.revokeObjectURL(url);
            hasDefinitionChanges = false;
            updateDefinitionsButton();
            alert('Test definitions file downloaded.\nMove it to the docs/ folder to replace the existing file.');
            return true;
        }

        // Manual save definitions (from button)
        async function saveDefinitions() {
            // Force re-request file handle
            fileHandleDefinitions = null;
            await saveDefinitionsAuto();
        }
    </script>
</body>
</html>
